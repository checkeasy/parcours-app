# ğŸ“ Changelog - CheckEasy Webhook Backend

## [2.2.3] - 2025-11-04

### ğŸ”„ Transformation des questions de checklist pour Bubble.io

#### ğŸ¯ AmÃ©lioration
Transformation automatique des questions de checklist vers le format attendu par Bubble.io.

#### ğŸ“¦ Mapping des champs
- `type: "oui-non"` â†’ `reponseType: "boolean"`
- `type: "ouverte"` â†’ `reponseType: "open"`
- `photoObligatoire` â†’ `photoIsRequired`
- `intitule` â†’ `intitule` (inchangÃ©)
- `obligatoire` â†’ `obligatoire` (inchangÃ©)

#### ğŸ“ Fichiers modifiÃ©s
- `server/services/webhookService.ts` - Ajout de la transformation des questions avant envoi

#### âœ… Impact
Les questions sont maintenant envoyÃ©es dans le format exact attendu par Bubble.io, Ã©vitant les erreurs de mapping cÃ´tÃ© backend Bubble.

---

## [2.2.2] - 2025-11-04

### âœ¨ Ajout des questions de checklist aux webhooks de logement

#### ğŸ¯ AmÃ©lioration
Ajout du paramÃ¨tre `questionsChecklist` au payload des webhooks de crÃ©ation de logement pour envoyer les questions de checklist de sortie.

#### ğŸ“¦ Structure des questions
Chaque question contient :
```json
{
  "id": "q-1",
  "intitule": "Le logement est-il propre ?",
  "type": "oui-non" | "ouverte",
  "photoObligatoire": true,
  "obligatoire": true
}
```

#### ğŸ”§ Logique d'extraction
- **ModÃ¨les prÃ©dÃ©finis** ("menage" ou "voyageur") : Tableau vide `[]`
- **ModÃ¨les personnalisÃ©s** : Utilise `modele.questionsChecklist` ou `[]` par dÃ©faut

#### ğŸ“ Fichiers modifiÃ©s
- `server/services/webhookService.ts` - Ajout de `questionsChecklist` au payload de logement
- `server/services/webhookService.ts` - Ajout d'un log pour afficher le nombre de questions

#### âœ… Impact
Les questions de checklist configurÃ©es dans les modÃ¨les personnalisÃ©s sont maintenant envoyÃ©es Ã  Bubble.io lors de la crÃ©ation du logement, permettant de crÃ©er le parcours avec les bonnes questions de sortie.

---

## [2.2.1] - 2025-11-04

### ğŸ”§ Ajout du paramÃ¨tre `etatLieuxMoment` aux webhooks de logement

#### ğŸ¯ AmÃ©lioration
Ajout du paramÃ¨tre `etatLieuxMoment` au payload des webhooks de crÃ©ation de logement pour indiquer le moment de prise de photos.

#### ğŸ“¦ Valeurs possibles
- `"sortie"` - Photos uniquement Ã  la sortie (check-out)
- `"arrivee-sortie"` - Photos Ã  l'arrivÃ©e et Ã  la sortie (check-in et check-out)

#### ğŸ”§ Logique d'extraction
- **ModÃ¨les prÃ©dÃ©finis** ("menage" ou "voyageur") : Valeur par dÃ©faut `"arrivee-sortie"`
- **ModÃ¨les personnalisÃ©s** : Utilise `modele.etatLieuxMoment` ou `"arrivee-sortie"` par dÃ©faut

#### ğŸ“ Fichiers modifiÃ©s
- `server/services/webhookService.ts` - Ajout de `etatLieuxMoment` au payload de logement
- `server/services/webhookService.ts` - Ajout d'un log pour afficher la valeur dans les webhooks de modÃ¨le

#### âœ… Impact
Ce paramÃ¨tre permet Ã  Bubble.io de crÃ©er le bon type de parcours d'inspection (sortie uniquement ou arrivÃ©e + sortie).

---

## [2.2.0] - 2025-11-04

### âœ¨ Webhook pour crÃ©ation de modÃ¨les personnalisÃ©s

#### ğŸ¯ Nouvelle fonctionnalitÃ©
Ajout d'un webhook pour envoyer les modÃ¨les personnalisÃ©s (modÃ¨les de parcours) Ã  Bubble.io lors de leur crÃ©ation.

#### ğŸ”§ ImplÃ©mentation
1. **Backend** : Nouvelle route `/api/send-modele-webhook`
2. **Service** : Fonction `sendModeleWebhookToBubble()` dans `webhookService.ts`
3. **Frontend** : Fonction `dispatchModeleWebhook()` dans `src/utils/webhook.ts`
4. **IntÃ©gration** : Appel automatique lors de la crÃ©ation d'un modÃ¨le personnalisÃ© dans `App.tsx`

#### ğŸ“¡ Endpoints Bubble.io
- **Test** : `https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/createmodeleparcour/initialize`
- **Production** : `https://checkeasy-57905.bubbleapps.io/api/1.1/wf/createmodeleparcour/initialize`

#### ğŸ“¦ Structure du payload
```json
{
  "conciergerieID": "...",
  "userID": "...",
  "modele": {
    "id": "custom-1234567890",
    "nom": "Mon ModÃ¨le PersonnalisÃ©",
    "type": "menage" | "voyageur",
    "etatLieuxMoment": "sortie" | "arrivee-sortie",
    "pieces": [...],
    "questionsChecklist": [...],
    "createdAt": "2025-11-04T...",
    "updatedAt": "2025-11-04T..."
  }
}
```

#### ğŸ“ Fichiers modifiÃ©s
- `server/routes/webhook.ts` - Nouvelle route pour modÃ¨le webhook
- `server/services/webhookService.ts` - Fonction `sendModeleWebhookToBubble()`
- `src/utils/webhook.ts` - Fonction `dispatchModeleWebhook()`
- `src/App.tsx` - Appel du webhook lors de la crÃ©ation d'un modÃ¨le

#### âœ… Fonctionnement
- Le webhook est envoyÃ© **uniquement lors de la crÃ©ation** d'un nouveau modÃ¨le
- **Pas de webhook** lors de la mise Ã  jour d'un modÃ¨le existant
- Utilise la mÃªme logique de test mode que les webhooks de logement
- Traitement asynchrone cÃ´tÃ© backend (non-bloquant)

---

## [2.1.2] - 2025-11-03

### ğŸ› Correction des noms de piÃ¨ces

#### ğŸ¯ ProblÃ¨me rÃ©solu
IncohÃ©rence entre les noms de piÃ¨ces dans le frontend et le backend, causant un nombre de tÃ¢ches incorrect (0 tÃ¢ches au lieu de 2-4).

#### âœ¨ Corrections apportÃ©es
1. **"Toilettes sÃ©parÃ©s"** : Correction de "Toilettes sÃ©parÃ©es" â†’ "Toilettes sÃ©parÃ©s" (sans "e")
2. **"Salle de bain (sans toilettes)"** : Ajout des parenthÃ¨ses manquantes

#### ğŸ“ Fichiers modifiÃ©s
- `server/services/webhookService.ts` - Correction des noms dans `TACHES_MENAGE` et `TACHES_VOYAGEUR`

#### âœ… RÃ©sultat
Les tÃ¢ches sont maintenant correctement rÃ©cupÃ©rÃ©es pour toutes les piÃ¨ces :
- "Toilettes sÃ©parÃ©s" : 4 tÃ¢ches (mÃ©nage) / 2 tÃ¢ches (voyageur)
- "Salle de bain (sans toilettes)" : 4 tÃ¢ches (mÃ©nage) / 3 tÃ¢ches (voyageur)

#### ğŸ” Log de dÃ©bogage ajoutÃ©
Ajout d'un log pour afficher le type de modÃ¨le utilisÃ© (prÃ©dÃ©fini vs personnalisÃ©) pour faciliter le dÃ©bogage futur.

---

## [2.1.1] - 2025-11-03

### ğŸ”§ Augmentation de la limite de payload

#### ğŸ¯ ProblÃ¨me rÃ©solu
Erreur 413 "Payload Too Large" lors de l'envoi de webhooks avec beaucoup d'images en base64.

#### âœ¨ Solution
Augmentation de la limite de taille du payload Express de 50mb Ã  **100mb**.

#### ğŸ“ Fichiers modifiÃ©s
- `server/index.ts` - Limite passÃ©e de `50mb` Ã  `100mb` pour `express.json()` et `express.urlencoded()`

#### âœ… RÃ©sultat
Le backend peut maintenant accepter des payloads jusqu'Ã  100mb, permettant l'envoi de logements avec de nombreuses photos en haute rÃ©solution.

---

## [2.1.0] - 2025-11-03

### âœ¨ Photos envoyÃ©es en tant qu'objets

#### ğŸ¯ AmÃ©lioration
Les photos sont maintenant envoyÃ©es Ã  Bubble sous forme d'objets au lieu de simples strings.

#### ğŸ“¦ Nouveau format
Chaque photo est maintenant un objet avec :
- `url` (string) - Pour les photos hÃ©bergÃ©es
- `type` (string) - "url"

OU

- `data` (string) - Pour les photos en base64
- `type` (string) - "base64"

**Exemple :**
```json
{
  "photos": [
    { "url": "https://example.com/photo.jpg", "type": "url" },
    { "data": "data:image/jpeg;base64,...", "type": "base64" }
  ]
}
```

#### ğŸ“ Fichiers modifiÃ©s
- `server/services/webhookService.ts` - Transformation des photos en objets
- `WEBHOOK_2STEP_WORKFLOW.md` - Documentation mise Ã  jour

#### âœ… Avantages
1. **Structure claire** : Type de photo explicite
2. **FacilitÃ© de traitement** : Bubble peut facilement distinguer les types
3. **ExtensibilitÃ©** : PossibilitÃ© d'ajouter d'autres champs Ã  l'avenir

#### ğŸ§ª Tests effectuÃ©s
âœ… Test avec 3 photos (2 URLs + 1 base64) : SuccÃ¨s complet

---

## [2.0.0] - 2025-11-03

### ğŸš€ Workflow en 2 Ã©tapes (BREAKING CHANGE)

#### ğŸ¯ ProblÃ¨me rÃ©solu
Le payload du webhook Ã©tait trop volumineux Ã  cause des images en base64, causant des timeouts et des erreurs 500 de Bubble.io.

#### âœ¨ Solution
Le webhook est maintenant divisÃ© en 2 Ã©tapes :

**Ã‰tape 1 :** CrÃ©er le logement et le parcours (SANS les piÃ¨ces)
- Endpoint : `/api/1.1/wf/webhookparcour`
- Payload allÃ©gÃ© sans les piÃ¨ces
- Retourne `logementID` et `parcourID`

**Ã‰tape 2 :** CrÃ©er chaque piÃ¨ce individuellement
- Endpoint : `/api/1.1/wf/createpiece/initialize`
- Une requÃªte par piÃ¨ce avec ses tÃ¢ches et photos
- Continue mÃªme si une piÃ¨ce Ã©choue

#### ğŸ“ Fichiers modifiÃ©s

- `src/config/webhooks.ts` - Ajout des endpoints pour les 2 Ã©tapes
- `server/services/webhookService.ts` - RÃ©Ã©criture complÃ¨te de `sendWebhookToBubble()`

#### ğŸ“Š Nouveaux logs

Le serveur affiche maintenant :
- Progression de l'Ã©tape 1 (crÃ©ation logement/parcours)
- Progression de l'Ã©tape 2 (crÃ©ation de chaque piÃ¨ce)
- RÃ©sumÃ© final avec nombre de piÃ¨ces crÃ©Ã©es/Ã©chouÃ©es

#### âš ï¸ Configuration requise dans Bubble.io

**Workflow `webhookparcour` (Ã‰tape 1) :**
- Doit retourner `{ "logementID": "...", "parcourID": "..." }` dans `response`

**Workflow `createpiece` (Ã‰tape 2) :**
- Doit Ãªtre en mode "initialization"
- Endpoint : `/api/1.1/wf/createpiece/initialize`

#### âœ… Avantages

1. **Payloads plus lÃ©gers** : Chaque requÃªte est plus petite
2. **Moins de timeouts** : RequÃªtes plus rapides
3. **Meilleure gestion des erreurs** : Si une piÃ¨ce Ã©choue, les autres continuent
4. **Logs dÃ©taillÃ©s** : Suivi prÃ©cis de chaque Ã©tape
5. **ScalabilitÃ©** : Peut gÃ©rer des logements avec beaucoup de piÃ¨ces

#### ğŸ“š Documentation

- Nouveau fichier : `WEBHOOK_2STEP_WORKFLOW.md` - Documentation complÃ¨te du workflow en 2 Ã©tapes

#### ğŸ§ª Tests effectuÃ©s

âœ… Ã‰tape 1 : Logement et parcours crÃ©Ã©s avec succÃ¨s dans Bubble
âš ï¸ Ã‰tape 2 : En attente de configuration du workflow `createpiece` dans Bubble

---

## [1.0.0] - 2025-11-03

### âœ¨ Ajout du backend webhook

#### ğŸ¯ Objectif
CrÃ©er un service backend pour gÃ©rer l'envoi des webhooks de maniÃ¨re asynchrone, Ã©vitant ainsi de bloquer l'interface utilisateur lors de l'envoi de gros payloads (images en base64).

#### ğŸ“ Nouveaux fichiers crÃ©Ã©s

**Backend :**
- `server/index.ts` - Point d'entrÃ©e du serveur Express
- `server/routes/webhook.ts` - Routes API pour les webhooks
- `server/services/webhookService.ts` - Logique mÃ©tier d'envoi des webhooks
- `server/tsconfig.json` - Configuration TypeScript pour le serveur
- `server/README.md` - Documentation technique du serveur

**Documentation :**
- `QUICK_START.md` - Guide de dÃ©marrage rapide
- `WEBHOOK_ARCHITECTURE.md` - Architecture dÃ©taillÃ©e du systÃ¨me de webhook
- `DEPLOYMENT.md` - Guide de dÃ©ploiement en production
- `CHANGELOG.md` - Ce fichier

**Scripts :**
- `start-all.ps1` - Script PowerShell pour dÃ©marrer backend + frontend
- `start-all.sh` - Script Bash pour Linux/Mac

#### ğŸ”§ Fichiers modifiÃ©s

**Frontend :**
- `src/utils/webhook.ts` - ModifiÃ© pour appeler le backend au lieu de Bubble.io directement
- `src/App.tsx` - Ajout du bouton "Relancer webhook" sur chaque logement
- `package.json` - Ajout des scripts et dÃ©pendances backend

**Documentation :**
- `README.md` - Mise Ã  jour avec les nouvelles fonctionnalitÃ©s

#### ğŸ“¦ Nouvelles dÃ©pendances

**Production :**
- `express` - Serveur HTTP
- `cors` - Gestion des requÃªtes cross-origin
- `node-fetch@2` - Client HTTP pour Node.js
- `iconv-lite` - Encodage de caractÃ¨res

**DÃ©veloppement :**
- `@types/express` - Types TypeScript pour Express
- `@types/cors` - Types TypeScript pour CORS
- `@types/node` - Types TypeScript pour Node.js
- `tsx` - ExÃ©cution TypeScript sans compilation
- `nodemon` - Auto-reload du serveur
- `concurrently` - ExÃ©cution simultanÃ©e de plusieurs scripts

#### ğŸš€ Nouveaux scripts npm

```json
{
  "server": "tsx watch server/index.ts",
  "server:prod": "tsx server/index.ts",
  "start": "concurrently \"npm run server\" \"npm run dev\" --names \"BACKEND,FRONTEND\" --prefix-colors \"cyan,magenta\""
}
```

#### ğŸ”„ Changements d'architecture

**Avant :**
```
Frontend â†’ Bubble.io directement
   â†“
âŒ Interface bloquÃ©e pendant l'envoi
âŒ Webhook arrÃªtÃ© si navigateur fermÃ©
âŒ ProblÃ¨mes avec gros payloads
```

**AprÃ¨s :**
```
Frontend â†’ Backend Server â†’ Bubble.io
   â†“              â†“
âœ… RÃ©ponse      âœ… Envoi en
   immÃ©diate       arriÃ¨re-plan
```

#### âœ… Avantages

1. **Asynchrone** : Le webhook continue mÃªme si le navigateur est fermÃ©
2. **Non-bloquant** : L'interface utilisateur reste rÃ©active
3. **Fiable** : Gestion optimale des gros payloads (images en base64)
4. **Logs dÃ©taillÃ©s** : Suivi en temps rÃ©el dans le terminal backend
5. **SÃ©paration des responsabilitÃ©s** : Frontend pour l'UI, backend pour la logique mÃ©tier
6. **Testable** : Endpoints sÃ©parÃ©s pour test et production

#### ğŸŒ Endpoints

**Backend API :**
- `POST /api/send-webhook` - Envoi d'un webhook
- `GET /health` - Health check

**Bubble.io :**
- Production : `https://checkeasy-57905.bubbleapps.io/version-live/api/1.1/wf/webhookparcour`
- Test : `https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/webhookparcour`

#### ğŸ“Š Payload structure

**EnvoyÃ© au backend :**
```json
{
  "conciergerieID": "...",
  "userID": "...",
  "isTestMode": true,
  "logementData": {
    "logementId": "...",
    "nom": "...",
    "adresse": "...",
    "parcoursType": "menage",
    "modele": "menage",
    "pieces": [...],
    "piecesPhotos": {...}
  }
}
```

**EnvoyÃ© Ã  Bubble.io :**
```json
{
  "conciergerieID": "...",
  "logementID": "...",
  "userID": "...",
  "nom": "...",
  "adresse": "...",
  "parcoursType": "menage",
  "nomParcours": "MÃ©nage Check Easy",
  "modele": { "type": "predefined", "value": "menage" },
  "pieces": [
    {
      "nom": "Cuisine",
      "quantite": 1,
      "tasks": [...],
      "photos": [...]
    }
  ]
}
```

#### ğŸ”‘ FonctionnalitÃ©s clÃ©s

1. **GÃ©nÃ©ration automatique de logementId**
   - Format : `logement_{timestamp}_{random}`
   - ConservÃ© lors du renvoi du webhook

2. **IntÃ©gration des tÃ¢ches**
   - Les tÃ¢ches sont automatiquement ajoutÃ©es aux piÃ¨ces selon le modÃ¨le
   - Support des modÃ¨les prÃ©dÃ©finis (menage/voyageur) et personnalisÃ©s

3. **Gestion des photos**
   - Support des URLs et des images en base64
   - Pas de limite de taille (limite de 50MB configurÃ©e dans Express)

4. **Mode test/production**
   - SÃ©lection automatique de l'endpoint selon le paramÃ¨tre URL `version-test`

5. **Bouton "Relancer webhook"**
   - Permet de renvoyer le webhook pour un logement existant
   - Conserve le mÃªme logementId pour la cohÃ©rence

#### ğŸ“ Logs du serveur

Le serveur affiche des logs dÃ©taillÃ©s :

```
ğŸ“¨ Received webhook request for logement: Appartement Paris
   - Test mode: YES
   - ConciergerieID: 1730741276842x778024514623373300
   - UserID: 1730741188020x554510837711264200

ğŸ“¤ Sending webhook to TEST endpoint...
   Endpoint: https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/webhookparcour
   Logement: Appartement Paris
   Pieces: 3
   Total photos: 5

âœ… Webhook sent successfully for logement: Appartement Paris
```

#### ğŸ§ª Tests effectuÃ©s

- âœ… Serveur dÃ©marre correctement sur le port 3001
- âœ… Health check rÃ©pond avec `{ status: 'ok' }`
- âœ… Webhook acceptÃ© et traitÃ© en arriÃ¨re-plan
- âœ… Logs dÃ©taillÃ©s affichÃ©s dans le terminal
- âœ… Webhook envoyÃ© avec succÃ¨s Ã  Bubble.io (endpoint test)
- âœ… Frontend reÃ§oit une rÃ©ponse immÃ©diate
- âœ… Bouton "Relancer webhook" fonctionne correctement

#### ğŸš€ DÃ©marrage

**Option 1 : Automatique (recommandÃ©)**
```bash
npm start
```

**Option 2 : Manuel**
```bash
# Terminal 1
npm run server

# Terminal 2
npm run dev
```

#### ğŸ“š Documentation

- [QUICK_START.md](QUICK_START.md) - Guide de dÃ©marrage rapide
- [WEBHOOK_ARCHITECTURE.md](WEBHOOK_ARCHITECTURE.md) - Architecture dÃ©taillÃ©e
- [DEPLOYMENT.md](DEPLOYMENT.md) - Guide de dÃ©ploiement en production
- [server/README.md](server/README.md) - Documentation technique du serveur
- [README.md](README.md) - Documentation gÃ©nÃ©rale

#### ğŸ”® AmÃ©liorations futures possibles

- [ ] Ajouter une authentification (API Key, JWT)
- [ ] ImplÃ©menter un systÃ¨me de retry en cas d'Ã©chec
- [ ] Ajouter un rate limiter pour Ã©viter les abus
- [ ] Stocker l'historique des webhooks envoyÃ©s
- [ ] Ajouter des mÃ©triques et monitoring (Prometheus, Grafana)
- [ ] ImplÃ©menter une queue de messages (Redis, RabbitMQ)
- [ ] Ajouter des tests unitaires et d'intÃ©gration
- [ ] DÃ©ployer le backend en production (Railway, Render, Heroku)

#### ğŸ› Bugs corrigÃ©s

- âœ… ProblÃ¨me de dÃ©pendance `iconv-lite` rÃ©solu
- âœ… Configuration TypeScript corrigÃ©e pour le serveur
- âœ… Installation des dÃ©pendances Express manquantes

#### âš ï¸ Breaking Changes

Aucun breaking change. Le systÃ¨me est rÃ©trocompatible.

#### ğŸ™ Remerciements

Merci Ã  l'Ã©quipe CheckEasy pour les spÃ©cifications et les tests !

---

**Version :** 1.0.0  
**Date :** 2025-11-03  
**Auteur :** Ã‰quipe CheckEasy


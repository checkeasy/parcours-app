# ğŸ”„ Chargement des ModÃ¨les depuis Bubble.io

## ğŸ¯ Vue d'ensemble

Le systÃ¨me de chargement des modÃ¨les permet de **synchroniser automatiquement** les modÃ¨les personnalisÃ©s crÃ©Ã©s dans l'application avec Bubble.io. Les modÃ¨les sont chargÃ©s au dÃ©marrage de l'application et peuvent Ãªtre rechargÃ©s manuellement.

---

## ğŸ“¡ Endpoint Bubble.io

### Configuration

| Mode | Endpoint |
|------|----------|
| **Test** | `https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/apireturnmodeleforapp` |
| **Production** | `https://checkeasy-57905.bubbleapps.io/api/1.1/wf/apireturnmodeleforapp` |

### RequÃªte

- **MÃ©thode** : `GET`
- **ParamÃ¨tre** : `conciergerie` (ID de la conciergerie)
- **Exemple** : `?conciergerie=1730741276842x778024514623373300`

### RÃ©ponse

```json
{
  "status": "success",
  "response": {
    "data": [
      {
        "_id": "1762265543692x203300711359588160",
        "nom": "voyageur",
        "Type Parcours": "Voyageur",
        "TypePhoto": "Ã€ l'arrivÃ©e et Ã  la sortie",
        "Created Date": 1762265543701,
        "Modified Date": 1762265543703,
        "conciergerie": "1730741276842x778024514623373300",
        "Data Template parcour": {
          "body_raw_text": "{\"conciergerieID\":\"...\",\"userID\":\"...\",\"modele\":{...}}",
          "_api_c2_returned_an_error": false
        }
      }
    ]
  }
}
```

---

## ğŸ”§ Parsing du `body_raw_text`

Le champ `Data Template parcour.body_raw_text` contient un **JSON stringifiÃ©** avec la structure suivante :

```json
{
  "conciergerieID": "1730741276842x778024514623373300",
  "userID": "1730741188020x554510837711264200",
  "modele": {
    "id": "custom-1762265537170",
    "nom": "voyageur",
    "type": "voyageur",
    "etatLieuxMoment": "arrivee-sortie",
    "pieces": [
      {
        "id": "piece-1762265537170-Cuisine",
        "nom": "Cuisine",
        "tachesDisponibles": [...],
        "tachesSelectionnees": [...]
      }
    ],
    "questionsChecklist": [],
    "createdAt": "2025-11-04T14:12:17.170Z",
    "updatedAt": "2025-11-04T14:12:17.170Z"
  }
}
```

**Extraction** : On parse le JSON et on extrait l'objet `modele` qui correspond Ã  l'interface `ParcoursModele`.

---

## ğŸ“¦ Fonctions utilitaires

### `loadModelesFromBubble()`

Charge les modÃ¨les depuis Bubble.io.

```typescript
const modeles = await loadModelesFromBubble(
  "1730741276842x778024514623373300", // conciergerieID
  true // isTestMode
);
```

**Retour** : `Promise<ParcoursModele[]>`

**Logs** :
```
ğŸ“¥ Chargement des modÃ¨les depuis Bubble.io...
   Endpoint: https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/apireturnmodeleforapp
   Conciergerie: 1730741276842x778024514623373300
   Mode: TEST
   âœ… 2 modÃ¨le(s) trouvÃ©(s)
   âœ… ModÃ¨le chargÃ©: "voyageur" (voyageur)
      - PiÃ¨ces: 1
      - Questions: 0
      - Ã‰tat des lieux: arrivee-sortie
   âœ… ModÃ¨le chargÃ©: "Test modele 2" (menage)
      - PiÃ¨ces: 3
      - Questions: 3
      - Ã‰tat des lieux: arrivee-sortie

âœ… 2 modÃ¨le(s) chargÃ©(s) avec succÃ¨s
```

---

### `loadAndMergeModeles()`

Charge les modÃ¨les depuis Bubble.io et les fusionne avec les modÃ¨les locaux.

```typescript
const mergedModeles = await loadAndMergeModeles(
  "1730741276842x778024514623373300", // conciergerieID
  localModeles, // ModÃ¨les stockÃ©s localement
  true // isTestMode
);
```

**Logique de fusion** :
1. Charger les modÃ¨les depuis Bubble.io
2. CrÃ©er un Map des modÃ¨les Bubble par ID
3. CrÃ©er un Map des modÃ¨les locaux par ID
4. Ajouter tous les modÃ¨les Bubble (prioritÃ©)
5. Ajouter les modÃ¨les locaux qui ne sont pas dans Bubble

**Retour** : `Promise<ParcoursModele[]>`

**Logs** :
```
ğŸ“Š Fusion des modÃ¨les:
   - ModÃ¨les Bubble: 2
   - ModÃ¨les locaux: 3
   - ModÃ¨les fusionnÃ©s: 4
```

---

### `saveModelesToLocalStorage()`

Sauvegarde les modÃ¨les dans le localStorage.

```typescript
saveModelesToLocalStorage(modeles);
```

**Logs** :
```
ğŸ’¾ 2 modÃ¨le(s) sauvegardÃ©(s) dans le localStorage
```

---

### `loadModelesFromLocalStorage()`

Charge les modÃ¨les depuis le localStorage.

```typescript
const modeles = loadModelesFromLocalStorage();
```

**Retour** : `ParcoursModele[]`

**Logs** :
```
ğŸ’¾ 2 modÃ¨le(s) chargÃ©(s) depuis le localStorage
```

---

## ğŸš€ IntÃ©gration dans l'application

### Chargement au dÃ©marrage

Dans `App.tsx`, un `useEffect` charge automatiquement les modÃ¨les au dÃ©marrage :

```typescript
useEffect(() => {
  const loadModeles = async () => {
    setIsLoadingModeles(true);
    try {
      console.log("ğŸš€ Chargement des modÃ¨les au dÃ©marrage de l'application...");
      
      // Charger les modÃ¨les locaux
      const localModeles = loadModelesFromLocalStorage();
      
      // Charger et fusionner avec les modÃ¨les Bubble
      const mergedModeles = await loadAndMergeModeles(
        CONCIERGERIE_ID,
        localModeles,
        IS_TEST_MODE
      );
      
      // Mettre Ã  jour l'Ã©tat
      setCustomModeles(mergedModeles);
      
      // Sauvegarder dans le localStorage
      saveModelesToLocalStorage(mergedModeles);
      
      console.log("âœ… ModÃ¨les chargÃ©s avec succÃ¨s");
    } catch (error) {
      console.error("âŒ Erreur lors du chargement des modÃ¨les:", error);
      toast({
        title: "Erreur de chargement",
        description: "Impossible de charger les modÃ¨les depuis Bubble.io. Utilisation des modÃ¨les locaux.",
        variant: "destructive",
      });
    } finally {
      setIsLoadingModeles(false);
    }
  };

  loadModeles();
}, []); // ExÃ©cuter une seule fois au dÃ©marrage
```

---

### Rechargement manuel

Un bouton "Recharger les modÃ¨les" permet de synchroniser manuellement :

```typescript
const handleReloadModeles = async () => {
  setIsLoadingModeles(true);
  try {
    console.log("ğŸ”„ Rechargement manuel des modÃ¨les...");
    
    const bubbleModeles = await loadModelesFromBubble(CONCIERGERIE_ID, IS_TEST_MODE);
    
    setCustomModeles(bubbleModeles);
    saveModelesToLocalStorage(bubbleModeles);
    
    toast({
      title: "ModÃ¨les rechargÃ©s !",
      description: `${bubbleModeles.length} modÃ¨le(s) chargÃ©(s) depuis Bubble.io.`,
    });
  } catch (error) {
    console.error("âŒ Erreur lors du rechargement des modÃ¨les:", error);
    toast({
      title: "Erreur de rechargement",
      description: "Impossible de recharger les modÃ¨les depuis Bubble.io.",
      variant: "destructive",
    });
  } finally {
    setIsLoadingModeles(false);
  }
};
```

**Interface** :
```tsx
<Button 
  onClick={handleReloadModeles} 
  size="lg" 
  variant="outline"
  disabled={isLoadingModeles}
>
  <RefreshCw className={`mr-2 h-4 w-4 ${isLoadingModeles ? 'animate-spin' : ''}`} />
  {isLoadingModeles ? 'Chargement...' : 'Recharger les modÃ¨les'}
</Button>
```

---

### Sauvegarde lors de la crÃ©ation

Lors de la crÃ©ation d'un nouveau modÃ¨le, il est automatiquement sauvegardÃ© :

```typescript
const handleSaveCustomModele = async (modele: ParcoursModele) => {
  let updatedModeles: ParcoursModele[];

  if (editingModele) {
    // Mise Ã  jour
    updatedModeles = customModeles.map(m => m.id === modele.id ? modele : m);
  } else {
    // CrÃ©ation
    updatedModeles = [...customModeles, modele];
    
    // Envoyer le webhook Ã  Bubble.io
    await dispatchModeleWebhook(modele);
  }

  setCustomModeles(updatedModeles);
  
  // Sauvegarder dans le localStorage
  saveModelesToLocalStorage(updatedModeles);
};
```

---

## ğŸ” Gestion des erreurs

### Erreur de chargement depuis Bubble.io

Si le chargement depuis Bubble.io Ã©choue, l'application utilise les modÃ¨les locaux :

```typescript
try {
  const mergedModeles = await loadAndMergeModeles(...);
  setCustomModeles(mergedModeles);
} catch (error) {
  console.error("âŒ Erreur lors du chargement des modÃ¨les:", error);
  toast({
    title: "Erreur de chargement",
    description: "Impossible de charger les modÃ¨les depuis Bubble.io. Utilisation des modÃ¨les locaux.",
    variant: "destructive",
  });
}
```

### Erreur de parsing

Si un modÃ¨le ne peut pas Ãªtre parsÃ©, il est ignorÃ© :

```typescript
for (const item of data.response.data) {
  try {
    const parsed = JSON.parse(bodyRawText);
    const modele = parsed.modele;
    modeles.push(modele);
  } catch (parseError) {
    console.error(`âŒ Erreur lors du parsing du modÃ¨le "${item.nom}":`, parseError);
    continue; // Ignorer ce modÃ¨le et continuer
  }
}
```

---

## ğŸ“Š Flux de donnÃ©es complet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DÃ©marrage de l'application                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          1. Charger les modÃ¨les depuis localStorage         â”‚
â”‚             loadModelesFromLocalStorage()                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          2. Charger les modÃ¨les depuis Bubble.io            â”‚
â”‚             loadModelesFromBubble()                         â”‚
â”‚             GET /apireturnmodeleforapp?conciergerie=...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          3. Parser le body_raw_text de chaque modÃ¨le        â”‚
â”‚             JSON.parse(body_raw_text)                       â”‚
â”‚             Extraire modele.modele                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          4. Fusionner avec les modÃ¨les locaux               â”‚
â”‚             loadAndMergeModeles()                           â”‚
â”‚             PrioritÃ© aux modÃ¨les Bubble                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          5. Mettre Ã  jour l'Ã©tat de l'application           â”‚
â”‚             setCustomModeles(mergedModeles)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          6. Sauvegarder dans le localStorage                â”‚
â”‚             saveModelesToLocalStorage(mergedModeles)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Checklist de vÃ©rification

Lors du chargement des modÃ¨les, vÃ©rifiez que :

- [ ] Les logs affichent le nombre de modÃ¨les chargÃ©s depuis Bubble.io
- [ ] Les logs affichent le nombre de modÃ¨les fusionnÃ©s
- [ ] Les modÃ¨les sont correctement affichÃ©s dans l'interface
- [ ] Le bouton "Recharger les modÃ¨les" fonctionne
- [ ] Les modÃ¨les sont sauvegardÃ©s dans le localStorage
- [ ] En cas d'erreur, les modÃ¨les locaux sont utilisÃ©s

---

## ğŸ› DÃ©bogage

### VÃ©rifier les logs de chargement

Ouvrez la console du navigateur et cherchez :

```
ğŸš€ Chargement des modÃ¨les au dÃ©marrage de l'application...
ğŸ“¥ Chargement des modÃ¨les depuis Bubble.io...
   âœ… 2 modÃ¨le(s) trouvÃ©(s)
   âœ… ModÃ¨le chargÃ©: "voyageur" (voyageur)
ğŸ“Š Fusion des modÃ¨les:
   - ModÃ¨les Bubble: 2
   - ModÃ¨les locaux: 0
   - ModÃ¨les fusionnÃ©s: 2
ğŸ’¾ 2 modÃ¨le(s) sauvegardÃ©(s) dans le localStorage
âœ… ModÃ¨les chargÃ©s avec succÃ¨s
```

### Tester manuellement l'endpoint

```bash
curl "https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/apireturnmodeleforapp?conciergerie=1730741276842x778024514623373300"
```

### VÃ©rifier le localStorage

Dans la console du navigateur :

```javascript
JSON.parse(localStorage.getItem('custom-modeles'))
```

---

## ğŸ“ Fichiers impliquÃ©s

| Fichier | RÃ´le |
|---------|------|
| `src/utils/loadModeles.ts` | Fonctions utilitaires pour charger les modÃ¨les |
| `src/App.tsx` | IntÃ©gration du chargement au dÃ©marrage |
| `src/types/modele.ts` | Interface `ParcoursModele` |

---

## ğŸš€ Prochaines Ã©tapes

- [ ] Ajouter un indicateur de synchronisation dans l'interface
- [ ] ImplÃ©menter un systÃ¨me de cache avec expiration
- [ ] Ajouter la gestion des conflits (modÃ¨le modifiÃ© localement et sur Bubble)
- [ ] ImplÃ©menter la suppression de modÃ¨les cÃ´tÃ© Bubble.io


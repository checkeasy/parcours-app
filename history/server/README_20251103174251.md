# Backend Server - Webhook Service

Ce serveur backend gÃ¨re l'envoi des webhooks Ã  Bubble.io de maniÃ¨re asynchrone.

## ğŸ¯ Objectif

- DÃ©charger le frontend de l'envoi des webhooks
- Permettre l'envoi asynchrone mÃªme si le navigateur est fermÃ©
- GÃ©rer les payloads lourds (images en base64) sans bloquer l'interface utilisateur

## ğŸš€ DÃ©marrage

### Mode dÃ©veloppement (avec auto-reload)
```bash
npm run server
```

### Mode production
```bash
npm run server:prod
```

Le serveur dÃ©marre sur `http://localhost:3001`

## ğŸ“¡ Endpoints disponibles

### POST `/api/send-webhook`
Envoie un webhook Ã  Bubble.io de maniÃ¨re asynchrone.

**Body:**
```json
{
  "conciergerieID": "1730741276842x778024514623373300",
  "userID": "1730741188020x554510837711264200",
  "isTestMode": true,
  "logementData": {
    "logementId": "logement_1234567890_abc123",
    "nom": "Appartement Paris",
    "adresse": "15 Rue de la Paix, 75002 Paris",
    "airbnbLink": "https://www.airbnb.fr/rooms/12345678",
    "parcoursType": "menage",
    "modele": "menage",
    "pieces": [...],
    "piecesPhotos": {...}
  }
}
```

**Response:**
```json
{
  "success": true,
  "message": "Webhook request accepted and processing in background",
  "logementId": "logement_1234567890_abc123"
}
```

### GET `/health`
VÃ©rifie que le serveur fonctionne.

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

## ğŸ”§ Configuration

### Endpoints Bubble.io

Les endpoints sont configurÃ©s dans `server/services/webhookService.ts`:

- **Production:** `https://checkeasy-57905.bubbleapps.io/version-live/api/1.1/wf/webhookparcour`
- **Test:** `https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/webhookparcour`

### Limite de taille du payload

Le serveur accepte des payloads jusqu'Ã  **100mb** pour gÃ©rer les images en base64.

Configuration dans `server/index.ts`:
```typescript
app.use(express.json({ limit: '100mb' }));
app.use(express.urlencoded({ extended: true, limit: '100mb' }));
```

Cette limite permet d'envoyer des logements avec de nombreuses photos en haute rÃ©solution sans erreur 413 "Payload Too Large".

## ğŸ“ Structure

```
server/
â”œâ”€â”€ index.ts                    # Point d'entrÃ©e du serveur
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ webhook.ts             # Routes pour les webhooks
â”œâ”€â”€ services/
â”‚   â””â”€â”€ webhookService.ts      # Logique d'envoi des webhooks
â”œâ”€â”€ tsconfig.json              # Configuration TypeScript
â””â”€â”€ README.md                  # Ce fichier
```

## ğŸ”„ Fonctionnement

1. Le frontend envoie une requÃªte Ã  `/api/send-webhook`
2. Le serveur rÃ©pond immÃ©diatement avec un statut "accepted"
3. Le webhook est envoyÃ© Ã  Bubble.io en arriÃ¨re-plan
4. Le serveur continue de fonctionner mÃªme si le navigateur est fermÃ©

## ğŸ“ Logs

Le serveur affiche des logs dÃ©taillÃ©s dans la console:

```
ğŸš€ Server running on http://localhost:3001
ğŸ“¡ Webhook API available at http://localhost:3001/api/send-webhook
ğŸ’š Health check at http://localhost:3001/health

ğŸ“¨ Received webhook request for logement: Appartement Paris
   - Test mode: YES
   - ConciergerieID: 1730741276842x778024514623373300
   - UserID: 1730741188020x554510837711264200

ğŸ“¤ Sending webhook to TEST endpoint...
   Endpoint: https://checkeasy-57905.bubbleapps.io/version-test/api/1.1/wf/webhookparcour
   Logement: Appartement Paris
   Pieces: 3
   Total photos: 5

âœ… Webhook sent successfully for logement: Appartement Paris
```

## âš ï¸ Important

- Le serveur doit Ãªtre dÃ©marrÃ© **avant** d'utiliser l'application frontend
- Le serveur tourne sur le port `3001` (configurable via `PORT` env variable)
- Le frontend est configurÃ© pour appeler `http://localhost:3001`

## ğŸ› ï¸ DÃ©veloppement

Pour modifier les tÃ¢ches ou la logique de webhook, Ã©ditez:
- `server/services/webhookService.ts` - Logique d'envoi et dÃ©finitions des tÃ¢ches
- `server/routes/webhook.ts` - Routes et validation des requÃªtes

